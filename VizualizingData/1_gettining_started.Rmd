---
title: ""
output: learnr::tutorial
runtime: shiny_prerendered

# output:
#   bookdown::html_document2:
#     highlight: tango
#     toc: true
#     toc_float: true
#     css: ../css/style-chapters.css
--- 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
library("learnr")
library("tidyverse")
library("ggplot2")

# load penguine data set
data(penguins, package = 'palmerpenguins')

# set biostats theem
source("../Templates/biostats_theme.R")
theme_set(theme_biostats)
```

# Before you start {.facta}

You need to be:

- familiar with different types of data, such as continuous, categorical, dates.
- handle tibbles and tidyverse
- know how to install a package

## Getting started with ggplot

### Install the ggplot2 package

Before using the package for the first time, run this line in the **Console**:
 
```{r install, eval=FALSE, echo=TRUE}
install.packages("ggplot2")
```

To activate the package, run this code:
```{r load, eval=TRUE, echo=TRUE}
library(ggplot2)
```


## The basics

ggplot is based on the **grammar of graphics**, a terminology describing the components of a figure.
Let us have a look at these terms.

To produce a figure or plot, we take data values and use elements like dots, squares, lines, and colour to convert the data into a visual graphic.
There are many different ways to make a figure, but there are some rules that apply in general.
A plot is always built on data, and a number of other components called aestetics, geometry and scales.
These different components combined make up a figure

```{r ggplot-hierarchy, echo=FALSE, fig.cap="Visualization of how ggplots are built.", out.width = '100%'}
knitr::include_graphics("Figures/ggplot_setup_final.png")
```

## The code

The basic code for a scatterplot looks something like this:
```{r basic-plot, echo = TRUE, eval = FALSE}
ggplot(data, aes(x, y, colour)) +
  geom_point()
```


The main function is `ggplot()` and this is where the data and the aestetics are defined.
The **data** is on object containing the variables to produce the figure.
In the **aestetics**, the position usually x and y are defined, which describes the location of the data in the plot.
In the **aestetics** other options like colour, linetype or size can be added.
The other components of the plot are added with the `+` sign.
You can think of it as different layers that are put on top of each other see \@ref(fig:ggplot-hierarchy).



## The Palmer Penguin dataset

We will to a large extent work with the **Palmer Penguine** dataset [@Horst2020-jy].
If you are unfamiliar with the dataset have a look at this webpage: https://github.com/allisonhorst/palmerpenguins

To install the dataset run this code:
```{r install-palmer, eval=FALSE, echo=TRUE}
install.packages("palmerpenguins")

data(package = 'palmerpenguins')
```

The datasets contains 344 data points from 3 different species of penguins, collected from 3 islands in the Palmer Archipelago, Antarctica.
Further, it contains several traits and variables like bill length, depth, flipper length, body mass, sex and year.
```{r first-look, eval=TRUE, echo=TRUE}
penguins
```



## The components

Now we will describe the different components a ggplot is made of.

### Data
We use the function `ggplot()` to make figures.
The first element in this function is the **data object** containing all the variables you need to make the figure.

Your might have learnt to organize your data with one observation per row, which is generally a good strategy.
For making plots, it is however often useful to have your data in a long format (see XXX for more details).

This is how to add the data object in the `ggplot()` function.
For the Palmer Penguine dataset it will look like:

```{r data1, echo = TRUE, eval = TRUE, results='hide'}
ggplot(data = penguins)

```

`ggplot()` with a data object will produce an empty plot, because you have not given any instruction for how and where to show the data.


<br/><br/>

### Aestetics
The second element in the `ggplot()` function is called the **aestetics**.
The different elements from the aestetics are used to display the data.
The most important element is the **position** which describes the location of the data on the plot, usually by x and y.
Other important elements are **shape**, **fill**, **size**, **colour**, **line type** and **line width**, which describe how the data is displayed on the plot.

We want to plot the bill length against the bill depth in the Palmer Penguine dataset.
For this we define `x = bill_length_mm` and `y = bill_depth_mm`.
We also want to display the different penguine species using different colours.
For this, we type `colour = species`.

```{r aestetic, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species))
```

Not much more has happened yet, but the plot has a x and y axis.
The position for the data points are set.
The next step is to define how to display the data, using **geoms**.

One thing that might be confusing about the argument colour is that it only allows to be a factor from the dataset, for example `colour = species` or `colour = island`. 
For example `colour = "red"` does not work.
If you want to choose specific colours, this has to be done in **geom** or **scale** (see below).


<br/><br/>

### Geoms
To plot the actual data, we need to add **geom**.
There are many different **geom** you can choose from, to display the data as points, lines, distributions among others.
See \@ref(different-types-of-data-vizualization) for an overview.

Here, we want to make a scatterplot and display the data as points.
For this we use `geom_point()`.
Note that the legend is automatically plotted on the right side of the plot.

```{r add-geom, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point()
```

To illustrate the problem with colour in the previous section, you can use `colour = "red"` inside `geom_point()` and it will make all the points red.
Note that this time we chose `shape = species`, another aestetics to use different symbols for the three species.

```{r red, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, shape = species)) +
  geom_point(colour = "red")
```
<br/><br/>


### Scale
**Scales** controls the mapping of the **data** to the **aestetics**.
With **scales** you can manipulate the labels, breaks, text, make transformations like scale, convert and invert and much more.
The scales are produced automatically in ggplot, but you can manually change all of them, which gives you a lot of control of the plot.

Here, we present just a small selection to show what is possible.
The next section \@ref(essential-ggplot-elements) will introduce you to more options.

In the Palmer Penguin example, we log transform the y axis, change the axis titles of both axis, and manipulate the colours, all using different **scale** functions.

```{r scales, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point() +
  scale_y_log10(name = "Log bill length in mm") +
  scale_x_continuous(name = "Bill depth in mm") +
  scale_color_viridis_d()
```


### Labs
**Labs** is a useful function to modify the axis labels, titles and legend.
But as seen in the previous example, the axis names can also be modified with a **scale** function.

In the Palmer Penguin example, we now rename the axis titles and add a title and a tag to the figure.

```{r labs, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point() +
  scale_y_log10() +
  scale_x_continuous() +
  scale_color_viridis_d() +
  labs(x = "Bill depth in mm", y = "Log bill length in mm", title = "Bill length vs. depth in penguins", tag = "A")
```


### Facets
**Facets** can be used to divide the data into different subplots, which can be useful when vizualizing data from different groups.

In the Palmer Penguin example we can additionally show a panels for each island.
This is a good way to see which penguine species occurs on which island.

```{r facets, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point() +
  scale_y_log10() +
  scale_x_continuous() +
  scale_color_viridis_d() +
  labs(x = "Bill depth in mm", y = "Log bill length in mm", title = "Bill length vs. depth in penguins", tag = "A") +
  facet_wrap(~ island)
```
<br/><br/>


### Themes
**Themes** is a powerful element that controls the look of the plot.
In **themes** you can change, remove and add the background, gridlines, ticks, text, text size and much more.

In our example, we will increase the **text** of the **axis titles**, change the **colour** of the **axis text** and change the **theme** to **theme_minimal**.

```{r theme, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point() +
  scale_y_log10() +
  scale_x_continuous() +
  scale_color_viridis_d() +
  labs(x = "Bill depth in mm", y = "Log bill length in mm", title = "Bill length vs. depth in penguins", tag = "A") +
  facet_wrap(~ island) +
  theme_minimal() +
  theme(axis.title = element_text(size = 14),
        axis.text = element_text(colour = "purple"))

```

<br/><br/>


### stat_summary
**stat_summary** is a powerful function to visualize a summary of your data, for example showing **mean** values.

For this, we have to adapt the Palmer Penguin example.
Here, we show bill depth for each species in different colours.
Note that we are using the function `geom_jitter()`, which spreads the data on the x-axis, so that we can see all the data points.
Finally, we add the **mean** bill_depth for each species as a red big point.

```{r stat-summary, eval = TRUE}
ggplot(penguins, aes(x = species, y = bill_depth_mm, colour = species)) +
  geom_jitter() +
  scale_y_log10() +
  scale_color_viridis_d() +
  labs(x = "Species", y = "Log bill length in mm", title = "Bill length in penguins", tag = "A") +
  stat_summary(fun = "mean", colour = "red", size = 2)

```

<br/><br/>


### ggplots are layers of components
As you can see, there are almost no limits to what you can do in a ggplot.
The trick is to know which function changes which element.

The different components (geom, scale, stats) of the plot are **layers** that are plotted on top of each other and they appear in the order they are coded.
You can basically add as many **layers** of **geom**, **scale** etc. on top of each other as you want.
But there is a **trade-off**, of how much data and elements you add to a plot and the **clarity** of the visualization.

Here is another example of a plot with two different **geom** types.
We already know `geom_point()`, and in this case `geom_smooth`, draws a regression line for each penguin species.

```{r two-geoms, eval = TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point() +
  geom_smooth(method = "lm", formula = "y ~ x") +
  scale_y_log10() +
  scale_x_continuous() +
  scale_color_viridis_d() +
  labs(x = "Bill depth in mm", y = "Log bill length in mm", title = "Bill length vs. depth in penguins", tag = "A")
```


It is also possible to use different data sets to make one plot.
We are using the Palmer Penguin data set to plot bill length agains bill depth.
And now we also want to plot the mean bill length and bill depth for each penguin species on top of this plot.
For this, we calculate these values and store them in a new object.
Finally, we plot the means in the same plot using another `geom_point()`, and define the **data** and **aesthetics** again.
Note also that the colour and the size of these points are defined.

```{r two-type-data, eval = TRUE}
means <- penguins %>% 
  group_by(species) %>% 
  summarise(mean_bill_length = mean(bill_length_mm, na.rm = TRUE),
            mean_bill_depth = mean(bill_depth_mm, na.rm = TRUE))

ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point() +
  geom_point(data = means, aes(x = mean_bill_length, y = mean_bill_depth), colour = "red", size = 8) +
  scale_y_log10() +
  scale_x_continuous() +
  scale_color_viridis_d() +
  labs(x = "Bill depth in mm", y = "Log bill length in mm", title = "Bill length vs. depth in penguins", tag = "A")
```

Often it does not matter in which order the different components are added (although there are discussions around that topic, see here).
But in some cases the order is important, and you will quickly see if the order is wrong.

Let's have a look at the previous plot, where we added a red point for the mean bill length and depth for each penguin species.
The order we add the two `geom_point()` function matters.
If we switch the order, the means are plotted below the data points.
This can be intentional, but the means are less visible in this way.

```{r wrong-order, eval = TRUE}

ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point(data = means, aes(x = mean_bill_length, y = mean_bill_depth), colour = "red", size = 8) +
  geom_point() +
  scale_y_log10() +
  scale_x_continuous() +
  scale_color_viridis_d() +
  labs(x = "Bill depth in mm", y = "Log bill length in mm", title = "Bill length vs. depth in penguins", tag = "A")

```


## The exercise
Now it is your turn to practice.

We are using the Palmer Penguin data set, which you should be somewhat familiar with.
If you want to see how the data set looks like, type:

```{r view, eval = FALSE, echo=TRUE}
penguins %>% View()

```

### {.tabset}

#### Position x and y

We want to plot bill length againts bill depth.
Add the required code to make this plot.
The variables you need are called `bill_length_mm` and `bill_depth_mm`.

```{r position, exercise=TRUE}
ggplot(penguins, aes(x = , y = , colour = species)) +
  geom_point() +
  scale_color_viridis_d()

```

#### Colour
Now add the code to give each species in a different colour.

```{r colour, exercise=TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = )) +
  geom_point() +
  scale_color_viridis_d()

```


#### Geom
Add the code to plot the data as points.

```{r geom, exercise=TRUE}
ggplot(penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  
  scale_color_viridis_d()


```

### {.toc-ignore}
<br><br>


## Common mistakes {.tabset}

In the beginning you might make mistakes which will result in **error messages**, **warnings** or **incomplete plots**.
These mistakes often occur when the data or another component has been forgotten, because a `+` is missing at the end of a line or because of a typo.

Let us look at some **common mistakes**, the **error messages** and what will be displayed.
<br><br>


### No data
If you forget to specify the **data**, ggplot will not be able to make a plot and you will get the following **error message**:

```{r no-data, echo=TRUE, error=TRUE}
ggplot(aes(x = bill_length_mm, y = bill_depth_mm, colour = species)) +
  geom_point()
```


### Missing aesthetics
If you **forget to define the aestetics** `aes()` you will also get an **error message** and a empty plot:

```{r no-aestetics, echo=TRUE, error=TRUE, eval=TRUE}
ggplot(data = penguins) +
  geom_point()
```

### Missing geometry
If the **geometry is missing** `geom_point()`, ggplot will make a empty plot, with axis labels, but without data.
In this case there will **not be any error message**.

```{r no-geom}
ggplot(data = penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species))
```


### Missing `+`
If the you miss  `+`, ggplot will make a empty plot, with axis labels, and again without data.
The next line will show the following  **message**.

```{r plus}
ggplot(data = penguins, aes(x = bill_length_mm, y = bill_depth_mm, colour = species))
  geom_point()
```


# What's next? {.facta}

Next, we will show the [essential elements]() of a plot (title, axes, legend, ...) and you can learn how to change and adapt each of these elements.
Further you can learn the most common [plots types]() that are commonly used.
