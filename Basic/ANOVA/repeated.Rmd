---
output:
  html_document:
    css: custom-blockquote.css
---

```{r setup&variables, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# title: Repeated Measures ANOVA
# author: jonathan
# revised: 20/1/2020 

WEB <- c("https://bioceed.uib.no/dropfolder/bioSTATS/Rmd/Basic/ANOVA/repeated.html")
GIT <- c("https://github.com/jonathansoule/biostats/blob/master/Basic/ANOVA/repeated.Rmd")
library(nlme)
library(ggplot2)

```
**Repeated measures ANOVA** is a test that seems close to [one-way ANOVA](http://biostats.w.uib.no/one-way-anova/){target="_blank"} as it allows to check for differences between the means of three and more groups. The essential difference is that the groups are **dependent** (i.e. related). This means that the groups contains data or measurements from the same individuals. What differs in terms of design may be **when** measurements were taken (measurements were thus repeated in time: before, during and after an experiment OR every day during a given time frame, OR etc) or **in which circumstances or conditions measurements** were performed (for example, measurements were done 3 times, each time following application of a new drug). In this test, the null hypothesis states that the means of all groups are equal.

Assumptions are:

+ each **individual** is represented in the form of a **measurement in each of the tested groups** (there cannot be any missing value),
+ **normality of distribution**,
+ **sphericity**, which means that **equality of variance** is verified when comparing any two groups (all possible pairs of groups) in the experimental design,
+ groups do not contain **outliers**.

Unlike [one-way ANOVA](http://biostats.w.uib.no/one-way-anova/){target="_blank"} where one fits a linear model with `lm()`, you may fit a **linear mixed effect model** with the function `lme()` that is found in the package `nlme`. However, we need to tell the function that some of the measurements are not replicates but that they concern the same individual. We will thus use the argument `random=~1|subjects` in `lme()`.

Letâs take an example where 5 rats are weighed 4 times with intervals of 4 weeks (week8 to 20). Here is the code for the dataframe:

```{r dataframe}
rat.weight <- c(164,164,158,159,155,220,230,226,227,222,261,275,264,280,272,306,326,320,330,312)
rat.ID <- as.factor(rep(c("rat1","rat2","rat3", "rat4", "rat5"),4))
time.point <- as.factor(c(rep("week08",5), rep("week12",5), rep("week16",5), rep("week20",5)))
my.dataframe <- data.frame(rat.ID,time.point,rat.weight)
```
<br/><br/>

Letâs visualize the data with a multiple line chart:
```{r plot, echo=FALSE}
ggplot(my.dataframe, aes(x = time.point, y = rat.weight, group = rat.ID, color = rat.ID)) +
  geom_line(size = 1.25) +
  geom_point(size = 2) +
  scale_color_viridis_d()
```

<br/><br/>

Now, letâs check the assumption of normality of distribution:
```{r normality, echo=FALSE}
shapiro.test(rat.weight[time.point=="week08"])
shapiro.test(rat.weight[time.point=="week12"])
shapiro.test(rat.weight[time.point=="week16"])
shapiro.test(rat.weight[time.point=="week20"]) 
```

Everything looks fineâ¦ all p-values are above 0.05 so normality of distribution does not constitute a problem.

<br/><br/>

Let's now continue with the assumption of sphericity. Sphericity is commonly checked via [Mauchlyâs test](https://biostats.w.uib.no/test-for-sphericity-mauchly-test/){target="_blank"}. Running this test with the corresponding function `mauchly.test()` requires that we first create a matrix that contains the data `rat.weight`. In that matrix, individuals are shown in rows, and time points are shown in column. Here is the code for making the corresponding matrix called `neo`:

```{r matrix}
neo <- matrix(rat.weight, nrow = 5, ncol = 4)
neo
```
<br/><br/>

Now we can used `mauchly.test()` in combination with `lm()` to test for sphericity. The syntax is as follows:
```{r mauchly}
mauchly.test(lm(neo ~ 1), X = ~1)
```

The output returns a p-value over 0.05 meaning that the null hypothesis stating that there is no difference in variances for all pairwise group comparisons is accepted. 

<br/><br/>

#### Letâs go for the test with `lme()`

Since `lme()` is part of the package `nlme()`, you need to install and load it. Here is how to do it:

```{r nlme, eval=FALSE}
install.packages("nlme")
library(nlme)
```

The following code fits the linear mixed model. Here we must not forget to add the argument `random=~1|rat.ID` to link the repeated measurements to the corresponding individual in `rat.ID`:

```{r lme}
results.lme <- lme(rat.weight ~ time.point, random=~1|rat.ID, data=my.dataframe)
anova(results.lme)
```

The output shows a F-value close to 794 and a p-value under 0.0001. The null hypothesis can be rejected; there is a significant difference between the means of the groups. Unsurprisingly, this difference is due to the factor `time.point`.

<br/><br/>



#### But what about the assumption of normality of distribution is not met?

If so, you may use a non-parametric test called **Friedman rank sum test (or simply Friedman test)**.

The function to call in R is `friedman.test(data, factor1, factor2)` where `data` is the vector that contains the measurements, `factor1` is the grouping factor and `factor2` is the blocking factor (where the individual IDs are stored).

Using our example as exposed at the top of this page, the syntax is:

```{r friedman}
friedman.test(rat.weight, time.point, rat.ID)
```

The null hypothesis stating that there is no difference between the means of the groups is (again) rejected due to the low p-value.
<br/><br/>

***
<!-- UNCOMMENT TO ACTIVATE
Get the Rmarkdown file corresponding to this page on [GitHub](`r GIT`){target="_blank"}.
-->
